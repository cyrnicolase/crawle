<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<HTML
><HEAD
><TITLE
>pg_rewind</TITLE
><META
NAME="GENERATOR"
CONTENT="Modular DocBook HTML Stylesheet Version 1.79"><LINK
REV="MADE"
HREF="mailto:pgsql-docs@postgresql.org"><LINK
REL="HOME"
TITLE="PostgreSQL 9.6.0 手册"
HREF="index.html"><LINK
REL="UP"
TITLE="PostgreSQL 服务器应用"
HREF="reference-server.html"><LINK
REL="PREVIOUS"
TITLE="pg_resetxlog"
HREF="app-pgresetxlog.html"><LINK
REL="NEXT"
TITLE="pg_test_fsync"
HREF="pgtestfsync.html"><LINK
REL="STYLESHEET"
TYPE="text/css"
HREF="stylesheet.css"><META
HTTP-EQUIV="Content-Type"
CONTENT="text/html; charset=utf-8"><META
NAME="creation"
CONTENT="2017-12-17T04:56:33"></HEAD
><BODY
CLASS="REFENTRY"
>
<div style="text-align:right">
<a style="margin : 0px 0px 0px 10px;" href="https://github.com/postgres-cn/pgdoc-cn/issues/new" target="_blank" title="在Github上报告问题（请注明问题内容及所在章节）">问题报告</a>
<a style="margin : 0px 0px 0px 10px;" href="https://github.com/postgres-cn/pgdoc-cn/edit/9.6/postgresql/doc/src/sgml/ref/pg_rewind.sgml" target="_blank" 
title="直接在Github上纠错本页面">纠错本页面</a>
</div>
<DIV
CLASS="NAVHEADER"
><TABLE
SUMMARY="Header navigation table"
WIDTH="100%"
BORDER="0"
CELLPADDING="0"
CELLSPACING="0"
><TR
><TH
COLSPAN="4"
ALIGN="center"
VALIGN="bottom"
><A
HREF="index.html"
>PostgreSQL 9.6.0 手册</A
></TH
></TR
><TR
><TD
WIDTH="10%"
ALIGN="left"
VALIGN="top"
><A
TITLE="pg_resetxlog"
HREF="app-pgresetxlog.html"
ACCESSKEY="P"
>&#19978;&#19968;&#39029;</A
></TD
><TD
WIDTH="10%"
ALIGN="left"
VALIGN="top"
><A
HREF="reference-server.html"
ACCESSKEY="U"
>&#19978;&#19968;&#32423;</A
></TD
><TD
WIDTH="60%"
ALIGN="center"
VALIGN="bottom"
></TD
><TD
WIDTH="20%"
ALIGN="right"
VALIGN="top"
><A
TITLE="pg_test_fsync"
HREF="pgtestfsync.html"
ACCESSKEY="N"
>&#19979;&#19968;&#39029;</A
></TD
></TR
></TABLE
><HR
ALIGN="LEFT"
WIDTH="100%"></DIV
><H1
><A
NAME="APP-PGREWIND"
></A
><SPAN
CLASS="APPLICATION"
>pg_rewind</SPAN
></H1
><DIV
CLASS="REFNAMEDIV"
><A
NAME="AEN102386"
></A
><H2
>&#21517;&#31216;</H2
>pg_rewind&nbsp;--&nbsp;把一个<SPAN
CLASS="PRODUCTNAME"
>PostgreSQL</SPAN
>数据目录与另一个从它复制出来的数据目录同步</DIV
><DIV
CLASS="REFSYNOPSISDIV"
><A
NAME="AEN102390"
></A
><H2
>&#22823;&#32434;</H2
><P
><TT
CLASS="COMMAND"
>pg_rewind</TT
> [<TT
CLASS="REPLACEABLE"
><I
>option</I
></TT
>...]  {<TT
CLASS="OPTION"
>-D </TT
> | <TT
CLASS="OPTION"
>--target-pgdata</TT
>}<TT
CLASS="REPLACEABLE"
><I
> directory</I
></TT
> {<TT
CLASS="OPTION"
>--source-pgdata=<TT
CLASS="REPLACEABLE"
><I
>directory</I
></TT
></TT
> | <TT
CLASS="OPTION"
>--source-server=<TT
CLASS="REPLACEABLE"
><I
>connstr</I
></TT
></TT
>} </P
></DIV
><DIV
CLASS="REFSECT1"
><A
NAME="AEN102409"
></A
><H2
>简介</H2
><P
>   <SPAN
CLASS="APPLICATION"
>pg_rewind</SPAN
>是用于在集簇的时间线分叉以后，同步一个 PostgreSQL 集簇和同一集簇的另一份拷贝的工具。一种典型的场景是在故障切换后让旧的主服务器作为新主机的备机重新上线。
  </P
><P
>   其结果等效于把目标数据目录替换成源数据目录。数据文件中只有更改过的块才会被拷贝，所有其他的文件会被整个拷贝，包括配置文件。<SPAN
CLASS="APPLICATION"
>pg_rewind</SPAN
>比起做一个新的基础备份或者<SPAN
CLASS="APPLICATION"
>rsync</SPAN
>等工具的优势在于，<SPAN
CLASS="APPLICATION"
>pg_rewind</SPAN
>不要求读取集簇中未更改的块。这使得它在数据库很大并且在集簇间只有小部分块不同时速度很快。
  </P
><P
>   <SPAN
CLASS="APPLICATION"
>pg_rewind</SPAN
>检查源集簇和目标集簇的时间线历史来判断它们在哪一点分叉，并且期望在目标集簇的<TT
CLASS="FILENAME"
>pg_xlog</TT
>目录中找到 WAL 来返回到分叉点。分叉点可能会在目标时间线、源时间线或者它们的共同祖先上找到。在典型的失效场景中，目标集簇在分叉后很快就被关闭，这不是问题，但是如果目标集簇在分叉后已经运行了很长时间，旧的 WAL 文件可能已经不存在了。在这样的情况下，它们可以被手工从 WAL 归档复制到<TT
CLASS="FILENAME"
>pg_xlog</TT
>目录，或者通过配置<TT
CLASS="FILENAME"
>recovery.conf</TT
>在启动时取得。<SPAN
CLASS="APPLICATION"
>pg_rewind</SPAN
>的使用并不限于故障切换的场景，例如一个后备服务器可能被提升、运行一些写事务，然后被倒回再次成为一个后备。
  </P
><P
>   当目标服务器在运行了<SPAN
CLASS="APPLICATION"
>pg_rewind</SPAN
>之后第一次启动时，它将进入到恢复模式并且重放源服务器在分叉点之后产生的所有 WAL。如果运行<SPAN
CLASS="APPLICATION"
>pg_rewind</SPAN
>时有些 WAL 在源服务器上找不到，并且因此无法被<SPAN
CLASS="APPLICATION"
>pg_rewind</SPAN
>复制过来，则在目标服务器被启动时必须让这些 WAL 可用。这可以通过在目标数据目录中创建一个<TT
CLASS="FILENAME"
>recovery.conf</TT
>文件并且在其中使用一个适当的<TT
CLASS="VARNAME"
>restore_command</TT
>来实现。
  </P
><P
>   <SPAN
CLASS="APPLICATION"
>pg_rewind</SPAN
>要求目标服务器在<TT
CLASS="FILENAME"
>postgresql.conf</TT
>中启用了<A
HREF="runtime-config-wal.html#GUC-WAL-LOG-HINTS"
>wal_log_hints</A
>选项，或者在用<SPAN
CLASS="APPLICATION"
>initdb</SPAN
>初始化集簇时启用了数据校验。目前默认情况下这两者都没有被打开。<A
HREF="runtime-config-wal.html#GUC-FULL-PAGE-WRITES"
>full_page_writes</A
>也必须被设置为<TT
CLASS="LITERAL"
>on</TT
>，这是默认的。
  </P
></DIV
><DIV
CLASS="REFSECT1"
><A
NAME="AEN102436"
></A
><H2
>选项</H2
><P
>    <SPAN
CLASS="APPLICATION"
>pg_rewind</SPAN
>接受下列命令行参数：

    <P
></P
></P><DIV
CLASS="VARIABLELIST"
><DL
><DT
><TT
CLASS="OPTION"
>-D <TT
CLASS="REPLACEABLE"
><I
>directory</I
></TT
></TT
><BR><TT
CLASS="OPTION"
>--target-pgdata=<TT
CLASS="REPLACEABLE"
><I
>directory</I
></TT
></TT
></DT
><DD
><P
>        这个选项指定要与源数据目录同步的目标数据目录。在运行<SPAN
CLASS="APPLICATION"
>pg_rewind</SPAN
>之前目标服务器必须被干净地关闭。
       </P
></DD
><DT
><TT
CLASS="OPTION"
>--source-pgdata=<TT
CLASS="REPLACEABLE"
><I
>directory</I
></TT
></TT
></DT
><DD
><P
>        指定要和目标服务器同步的源服务器的数据目录的文件系统路径。这个选项要求源服务器必须被干净地关闭。
       </P
></DD
><DT
><TT
CLASS="OPTION"
>--source-server=<TT
CLASS="REPLACEABLE"
><I
>connstr</I
></TT
></TT
></DT
><DD
><P
>        指定一个 libpq 连接串用于连接要与目标服务器同步的源<SPAN
CLASS="PRODUCTNAME"
>PostgreSQL</SPAN
>服务器。该连接必须是一个具有超级用户访问权限的普通（非复制）连接。这个选项要求源服务器正在运行且不处于恢复模式。
       </P
></DD
><DT
><TT
CLASS="OPTION"
>-n</TT
><BR><TT
CLASS="OPTION"
>--dry-run</TT
></DT
><DD
><P
>        做除了实际修改目标目录之外的其他所有事情。
       </P
></DD
><DT
><TT
CLASS="OPTION"
>-P</TT
><BR><TT
CLASS="OPTION"
>--progress</TT
></DT
><DD
><P
>        启用进度报告。在从源集簇拷贝数据时，打开这个选项将会发送一个近似的进度报告。
       </P
></DD
><DT
><TT
CLASS="OPTION"
>--debug</TT
></DT
><DD
><P
>        打印冗长的调试输出，这主要对于调试<SPAN
CLASS="APPLICATION"
>pg_rewind</SPAN
>的开发者有用。
       </P
></DD
><DT
><TT
CLASS="OPTION"
>-V</TT
><BR><TT
CLASS="OPTION"
>--version</TT
></DT
><DD
><P
>显示版本信息然后退出。</P
></DD
><DT
><TT
CLASS="OPTION"
>-?</TT
><BR><TT
CLASS="OPTION"
>--help</TT
></DT
><DD
><P
>显示帮助然后退出。</P
></DD
></DL
></DIV
><P>
   </P
></DIV
><DIV
CLASS="REFSECT1"
><A
NAME="AEN102498"
></A
><H2
>环境</H2
><P
>   在使用<TT
CLASS="OPTION"
>--source-server</TT
>选项时，<SPAN
CLASS="APPLICATION"
>pg_rewind</SPAN
>也使用<SPAN
CLASS="APPLICATION"
>libpq</SPAN
>支持的环境变量（见<A
HREF="libpq-envars.html"
>第 32.14 &#33410;</A
>）。
  </P
></DIV
><DIV
CLASS="REFSECT1"
><A
NAME="AEN102505"
></A
><H2
>注解</H2
><DIV
CLASS="REFSECT2"
><A
NAME="AEN102507"
></A
><H3
>如何工作</H3
><P
>    其基本思想是从源集簇拷贝所有文件系统级别的改变到目标集簇：
   </P
><DIV
CLASS="PROCEDURE"
><OL
TYPE="1"
><LI
CLASS="STEP"
><P
>      以源集簇的时间线历史从目标集簇分叉出来的点之前的最后一个检查点为起点，扫描目标集簇的 WAL 日志。对于每一个 WAL 记录，读取每一个被动过的数据块。这会得到在目标集簇中从源集簇被分支出去以后所有被更改过的数据块列表。
     </P
></LI
><LI
CLASS="STEP"
><P
>      使用直接的文件系统访问（<TT
CLASS="OPTION"
>--source-pgdata</TT
>）或者 SQL （<TT
CLASS="OPTION"
>--source-server</TT
>），把所有那些更改过的块从源集簇拷贝到目标集簇。
     </P
></LI
><LI
CLASS="STEP"
><P
>      把所有其他诸如<TT
CLASS="FILENAME"
>pg_clog</TT
>和配置文件（除了关系文件之外所有的东西）从源集簇拷贝到目标集簇。
     </P
></LI
><LI
CLASS="STEP"
><P
>      从源集簇应用 WAL，从失效处创建的检查点开始（严格来说，<SPAN
CLASS="APPLICATION"
>pg_rewind</SPAN
>并不应用 WAL，它只是创建一个备份标签文件，该文件让<SPAN
CLASS="PRODUCTNAME"
>PostgreSQL</SPAN
>从那个检查点开始向前重放所有 WAL）。
     </P
></LI
></OL
></DIV
></DIV
></DIV
><DIV
CLASS="NAVFOOTER"
><HR
ALIGN="LEFT"
WIDTH="100%"><TABLE
SUMMARY="Footer navigation table"
WIDTH="100%"
BORDER="0"
CELLPADDING="0"
CELLSPACING="0"
><TR
><TD
WIDTH="33%"
ALIGN="left"
VALIGN="top"
><A
HREF="app-pgresetxlog.html"
ACCESSKEY="P"
>&#19978;&#19968;&#39029;</A
></TD
><TD
WIDTH="34%"
ALIGN="center"
VALIGN="top"
><A
HREF="index.html"
ACCESSKEY="H"
>&#36215;&#22987;&#39029;</A
></TD
><TD
WIDTH="33%"
ALIGN="right"
VALIGN="top"
><A
HREF="pgtestfsync.html"
ACCESSKEY="N"
>&#19979;&#19968;&#39029;</A
></TD
></TR
><TR
><TD
WIDTH="33%"
ALIGN="left"
VALIGN="top"
><SPAN
CLASS="APPLICATION"
>pg_resetxlog</SPAN
></TD
><TD
WIDTH="34%"
ALIGN="center"
VALIGN="top"
><A
HREF="reference-server.html"
ACCESSKEY="U"
>&#19978;&#19968;&#32423;</A
></TD
><TD
WIDTH="33%"
ALIGN="right"
VALIGN="top"
><SPAN
CLASS="APPLICATION"
>pg_test_fsync</SPAN
></TD
></TR
></TABLE
></DIV
></BODY
></HTML
>
